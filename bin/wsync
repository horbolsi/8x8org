#!/usr/bin/env bash
set -Eeuo pipefail
cd "$(git rev-parse --show-toplevel)"

ts(){ date '+%Y-%m-%d %H:%M:%S'; }

FLAG_DIR="${TMPDIR:-$HOME/.cache}"
mkdir -p "$FLAG_DIR"
FLAG_FILE="$FLAG_DIR/wsync_stashed.flag"

status_clean(){ [[ -z "$(git status --porcelain)" ]]; }

auto_stash_begin() {
  if status_clean; then echo "✅ clean"; echo "0" > "$FLAG_FILE"; return 0; fi
  echo "ℹ️ stashing changes"
  git stash push -u -m "wsync auto-stash $(ts)" >/dev/null
  echo "1" > "$FLAG_FILE"
}

auto_stash_end() {
  if [[ "$(cat "$FLAG_FILE" 2>/dev/null || echo 0)" == "1" ]]; then
    echo "ℹ️ restoring stash"
    git stash pop >/dev/null || { echo "⚠️ stash pop conflict"; exit 1; }
  fi
}

ensure_on_branch() {
  git symbolic-ref -q HEAD >/dev/null 2>&1 || { echo "⚠️ DETACHED HEAD → run: bash bin/wsync rescue:main"; exit 2; }
}

pull_cmd() {
  auto_stash_begin
  if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
    git pull --rebase
  else
    git pull --rebase origin main
  fi
  auto_stash_end
}

push_cmd() {
  ensure_on_branch
  git add -A
  git commit -m "workspace sync $(ts)" >/dev/null 2>&1 || true
  git push
}

rescue_main() {
  git fetch origin --prune
  CURRENT="$(git rev-parse HEAD)"
  git checkout -B main origin/main
  git merge-base --is-ancestor "$CURRENT" HEAD >/dev/null 2>&1 || git cherry-pick "$CURRENT"
  git log --oneline --decorate -5
}

case "${1:-}" in
  pull) pull_cmd ;;
  push) push_cmd ;;
  sync) pull_cmd; push_cmd ;;
  backup) KEEP_BACKUPS="${KEEP_BACKUPS:-72}" bash scripts/backup_workspace.sh ;;
  doctor) echo "root: $(pwd)"; echo "branch: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo DETACHED)"; git remote -v; git status --porcelain; crontab -l 2>/dev/null || echo "(no crontab)";;
  rescue:main) rescue_main ;;
  *) echo "Usage: bash bin/wsync {pull|push|sync|backup|doctor|rescue:main}"; exit 2;;
esac
