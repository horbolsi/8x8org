#!/data/data/com.termux/files/usr/bin/bash
set -Eeuo pipefail
cd "$(git rev-parse --show-toplevel)"

ts(){ date '+%Y-%m-%d %H:%M:%S'; }

FLAG_DIR="${TMPDIR:-$HOME/.cache}"
mkdir -p "$FLAG_DIR"
FLAG_FILE="$FLAG_DIR/wsync_stashed.flag"

status_clean() { [[ -z "$(git status --porcelain)" ]]; }

auto_stash_begin() {
  if status_clean; then
    echo "✅ clean"
    echo "0" > "$FLAG_FILE"
    return 0
  fi
  echo "ℹ️ local changes detected → stashing for pull"
  git stash push -u -m "wsync auto-stash $(ts)" >/dev/null
  echo "1" > "$FLAG_FILE"
}

auto_stash_end() {
  if [[ "$(cat "$FLAG_FILE" 2>/dev/null || echo 0)" == "1" ]]; then
    echo "ℹ️ restoring stash"
    git stash pop >/dev/null || {
      echo "⚠️ stash pop conflicts. Fix files, then:"
      echo "  git add -A"
      echo "  git rebase --continue  (or: git rebase --abort)"
      exit 1
    }
  fi
}

cmd_pull() {
  auto_stash_begin
  git pull --rebase
  auto_stash_end
  git status --porcelain || true
}

cmd_push() {
  git add -A
  git commit -m "workspace sync $(ts)" >/dev/null 2>&1 || true
  git push
  git status --porcelain || true
}

cmd_sync() { cmd_pull; cmd_push; }

cmd_backup() {
  local keep="${KEEP_BACKUPS:-72}"
  echo "ℹ️ backup now (KEEP_BACKUPS=$keep)"
  bash scripts/backup_workspace.sh
}

cmd_doctor() {
  echo "--- wsync doctor ---"
  echo "root: $(pwd)"
  echo "branch: $(git rev-parse --abbrev-ref HEAD)"
  echo "head: $(git rev-parse --short HEAD)  $(git log -1 --pretty=%s)"
  echo
  echo "--- remotes ---"
  git remote -v
  echo
  echo "--- status ---"
  git status --porcelain || true
  echo
  echo "--- cron ---"
  crontab -l 2>/dev/null || echo "(no crontab)"
}

usage() {
  cat <<'USAGE'
Usage: bash bin/wsync <command>

Core:
  pull        Pull from GitHub (auto-stash)
  push        Commit+push to GitHub
  sync        pull then push
  status      show status
  backup      run backup now (uses scripts/backup_workspace.sh)
  doctor      show repo + remote + cron diagnostics
USAGE
}

case "${1:-}" in
  pull) cmd_pull ;;
  push) cmd_push ;;
  sync) cmd_sync ;;
  status) git status --porcelain ;;
  backup) cmd_backup ;;
  doctor) cmd_doctor ;;
  -h|--help|"") usage ;;
  *) echo "Unknown command: ${1:-}"; usage; exit 2 ;;
esac
